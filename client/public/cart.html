<!DOCTYPE html>
<html>
<head>
  <title>Carrinho</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #ddd; }
    .remove-btn { background: #dc3545; padding: 5px 10px; }
    .total { text-align: right; padding: 20px; font-size: 1.2em; }
  </style>
</head>
<body>
<nav class="navbar">
</nav>
<div class="container">
  <h2>Carrinho de compras</h2>
  <div id="cartItems"></div>
  <div class="total">Total: €<span id="cartTotal">0</span></div>
  <button onclick="checkout()" class="checkout-btn">Checkout</button>
</div>
<script>
  function displayCart() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const cartItems = document.getElementById('cartItems');
    const total = cart.reduce((sum, item) => sum + item.price, 0);

    cartItems.innerHTML = cart.map((item, index) => `
                <div class="cart-item">
                    <span>${item.name}</span>
                    <span>€${item.price}</span>
                    <button class="remove-btn" onclick="removeItem(${index})">Remover</button>
                </div>
            `).join('');

    document.getElementById('cartTotal').textContent = total.toFixed(2);
  }

  function removeItem(index) {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    cart.splice(index, 1);
    localStorage.setItem('cart', JSON.stringify(cart));
    displayCart();
  }

  async function checkout() {
    if (!localStorage.getItem('token')) {
      alert('Please login to checkout');
      window.location.href = '/login.html';
      return;
    }

    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const total = cart.reduce((sum, item) => sum + item.price, 0);

    try {
      const response = await fetch('http://localhost:3000/api/orders', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify({
          items: cart,
          total_amount: total
        })
      });

      if (response.ok) {
        localStorage.removeItem('cart');
        alert('Order placed successfully!');
        window.location.href = '/products.html';
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Checkout failed');
    }
  }

  displayCart();
</script>
<script src="/js/navbar.js"></script>
</body>
</html>